{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Inicio</title>
    <link rel="stylesheet" href="{% static 'css/genericas/base.css' %}" />
  <link rel="stylesheet" href="{% static 'css/administrador/listados.css' %}">
  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pathway+Gothic+One&display=swap" rel="stylesheet" />
  </head>
  <body>
<nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <img src="{% static 'images/LOGO_TREX.jpg' %}" alt="Logo">
      </div>

      

    <div class="login-nav">
    <ul>
      <li><a href="{% url 'login' %}">Iniciar Sesión</a></li>
    </ul>
  </div>
  </nav>


  <!-- SIDEBAR -->
  <div class="sidebar">
    <ul>
      <li><a href="{% url 'home' %}"><i class="fa-solid fa-house"></i> Regresar</a></li>
    </ul>
  </div>

<main class="page">
    <section class="center-area">

      <div id="subtitle">Plancha - Escanear QR y registrar cantidad</div>

        <div class="muted">Apunta con la cámara al QR.</div>

      <div class="controls">
        <button id="btn-start">Iniciar cámara</button>
        <button id="btn-stop">Detener</button>
        <input id="fileInput" type="file" accept="image/*">
        <select id="format">
          <option value="json">QR contiene JSON</option>
          <option value="plain">Texto plano</option>
        </select>
      </div>

      <div style="margin-top:.75rem">
        <div class="muted">Último QR leído:</div>
        <div id="last" class="scan-result">—</div>
      </div>

      <form id="workForm" class="form-card" autocomplete="off">
        <div style="display:flex;gap:.5rem">
          <div style="flex:1">
            <label>Empleado ID</label>
            <input id="employee_id" class="field" name="employee_id" />
          </div>
          <div style="width:120px">
            <label>Fecha / Hora</label>
            <input id="ts" class="field" name="timestamp" />
          </div>
        </div>

        <label>Trabajo / Orden / Tarjeta</label>
        <input id="job_id" class="field" name="job_id" />

        <label>Cantidad realizada</label>
        <input id="quantity" type="number" min="0" step="1" class="field" name="quantity" />

        <label>Comentarios (opcional)</label>
        <input id="notes" class="field" name="notes" />

        <button type="button" id="btn-submit" class="submit">Enviar registro</button>

        <div id="status" style="margin-top:.6rem;font-size:.95rem;color:#374151"></div>
      </form>

    <section id="demo-ajax">
    <h2>Gestión de Comentarios de Máquinas (Demo AJAX)</h2>
    
    <form id="form-comentario" style="display:none;margin-top:.5rem">
      {% csrf_token %}
        <input type="hidden" id="comentario-id" value="">
        <input type="number" id="comentario-maquina" placeholder="ID Máquina" required>
        <input type="number" id="comentario-empleado" placeholder="ID Empleado" required>
        <textarea id="comentario-texto" placeholder="Escribe tu comentario..." required></textarea>
        <button type="submit" id="btn-submit-comentario">Crear Comentario (POST)</button>
        <button type="button" id="btn-reset-form" style="background-color: #6c757d;">Limpiar</button>
    </form>
    <button id="btn-consultar">1. Consultar Todos (GET con .then)</button> 
    <button id="btn-dependiente">2. Demo Petición Dependiente (async/await)</button>

    <h3>Comentarios Registrados</h3>
    <ul id="lista-comentarios">
        </ul>
  </section>
      
</section>
</main>
<footer class="site-footer">Trex</footer>

</body>


<script>
    const API_URL = "/api/comentariosmaquinas/";
</script>
<script>
  const CREATE_ON_PAGE = true;
  document.addEventListener('DOMContentLoaded', () => {
    function getCSRFToken() {
      return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }
    const CSRF_TOKEN = getCSRFToken();
    const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN };
    const form = document.getElementById('form-comentario');
    if (!form) return;
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const maquina = document.getElementById('comentario-maquina')?.value;
      const empleado = document.getElementById('comentario-empleado')?.value;
      const texto = document.getElementById('comentario-texto')?.value;
      const datos = {
        maquina_id: maquina,
        empleado_id: empleado,
        comentario: texto,
        fecharegistro: new Date().toISOString(),
        solucionado: 0
      };
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(datos)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => null);
          console.error('POST error', err || res.status);
          alert('Error al crear comentario');
          return;
        }
        const data = await res.json();
        alert(`Comentario creado (ID ${data.idcomentariosmaquinas})`);
        form.reset();
      } catch (err) {
        console.error(err);
        alert('Error de red al crear comentario');
      }
    });
    // Form visibility: left hidden by default; reportes.js will show it when editing.
  });
</script>
<script src="{% static 'js/administrador/reportes.js' %}"></script>
</html>
