{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/administrador/homeAdmin.css' %}">

{% endblock %}

{% block content %}
  <section class="center-area">
    <div class="left-panel">
      <div class="contenedor">
        <div id="subtitle">Reportes Generales</div>
         {% csrf_token %}

  <nav>
        <ul>
      <li><a href="#reporte-maquina">Reporte por Máquina</a></li>
      <li><a href="#reporte-empleado">Reporte por Empleado</a></li>
      <li><a href="#reporte-productividad">Reporte de Productividad</a></li>
      <li><a href="#reporte-consumo">Reporte de Consumo de Hilo</a></li>
    </ul>
  </nav>

    <section id="reporte-maquina">
    <h2>Reporte por Máquina</h2>
      </section>
  <section id="reporte-empleado">
    <h2>Reporte por Empleado</h2>
      </section>
  <section id="reporte-productividad">
    <h2>Reporte de Productividad</h2>
      </section>
  <section id="reporte-consumo">
    <h2>Reporte de Consumo de Hilo</h2>
      </section>

  <section id="demo-ajax">
    <h2>Gestión de Comentarios de Máquinas (Demo AJAX)</h2>
    <p>Usa este formulario para probar las peticiones CRUD con Fetch.</p>
    
    <form id="form-comentario">
        <input type="hidden" id="comentario-id" value="">
        <input type="number" id="comentario-maquina" placeholder="ID Máquina" required>
        <input type="number" id="comentario-empleado" placeholder="ID Empleado" required>
        <textarea id="comentario-texto" placeholder="Escribe tu comentario..." required></textarea>
        <button type="submit" id="btn-submit-comentario">Crear Comentario (POST)</button>
        <button type="button" id="btn-reset-form" style="background-color: #6c757d;">Limpiar</button>
    </form>

    <button id="btn-consultar">1. Consultar Todos (GET con .then)</button>
    <button id="btn-dependiente">2. Demo Petición Dependiente (async/await)</button>

    <h3>Comentarios Registrados</h3>
    <ul id="lista-comentarios">
        </ul>
  </section>
    </div>
  </section>

{% endblock %}
{% block regresar %}
<div class="opcion" onclick="location.href='{% url 'login' %}'">Regresar</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    /* ==============================================
       CONFIGURACIÓN INICIAL (¡MUY IMPORTANTE!)
       ============================================== */

    // 1. URL de tu API para ComentariosMaquinas
    const API_URL = '/api/comentariosmaquinas/';

    // 2. Función para obtener el Token CSRF de la cookie de Django
    function getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue;
    }
    const CSRF_TOKEN = getCSRFToken();

    // 3. Headers reutilizables para peticiones que modifican datos
    const headersModificacion = {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF_TOKEN 
    };
    
    // 4. Elementos del DOM
    const listaComentarios = document.getElementById('lista-comentarios');
    const formComentario = document.getElementById('form-comentario');
    const btnConsultar = document.getElementById('btn-consultar');
    const btnDependiente = document.getElementById('btn-dependiente');
    const btnSubmitComentario = document.getElementById('btn-submit-comentario');
    const btnResetForm = document.getElementById('btn-reset-form');
    
    // Inputs del formulario
    const inputId = document.getElementById('comentario-id');
    const inputMaquina = document.getElementById('comentario-maquina');
    const inputEmpleado = document.getElementById('comentario-empleado');
    const inputTexto = document.getElementById('comentario-texto');


    /* ==============================================
       FUNCIONES HELPER (Ayuda)
       ============================================== */

    // Función para renderizar la lista de comentarios en el UL
    function renderComentarios(comentarios) {
        listaComentarios.innerHTML = ''; // Limpiar lista
        comentarios.forEach(com => {
            const li = document.createElement('li');
            li.className = com.solucionado ? 'solucionado' : '';
            li.setAttribute('data-id', com.idcomentariosmaquinas);
            
            li.innerHTML = `
                <div class="info">
                    <strong>[ID: ${com.idcomentariosmaquinas}]</strong> (Máquina: ${com.maquina_numero}, Empleado: ${com.empleado_nombre})
                    <p>${com.comentario}</p>
                    <small>Solucionado: ${com.solucionado ? 'Sí' : 'No'}</small>
                </div>
                <div class="acciones">
                    <button class="btn-solucionar" data-id="${com.idcomentariosmaquinas}">Marcar como ${com.solucionado ? 'Pendiente' : 'Solucionado'} (PATCH)</button>
                    <button class="btn-editar" data-id="${com.idcomentariosmaquinas}">Editar (Carga en form)</button>
                    <button class="btn-eliminar" data-id="${com.idcomentariosmaquinas}">Eliminar (DELETE)</button>
                </div>
            `;
            listaComentarios.appendChild(li);
        });
    }

    // Función para limpiar el formulario
    function resetForm() {
        inputId.value = '';
        inputMaquina.value = '';
        inputEmpleado.value = '';
        inputTexto.value = '';
        btnSubmitComentario.textContent = 'Crear Comentario (POST)';
        btnSubmitComentario.style.backgroundColor = '#28a745';
    }

    /* =========================================================
       PARTE 1: fetch con Encadenamiento de Promesas (.then)
       ========================================================= */

    /**
     * CONSULTAR (Read - GET)
     * Obtiene todos los comentarios.
     */
    function consultarComentariosConThen() {
        console.log('Consultando comentarios con .then()...');
        
        fetch(API_URL) // GET es el método por defecto
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la red: ' + response.statusText);
                }
                return response.json(); // Convierte la respuesta a JSON
            })
            .then(data => {
                // 'data' es el array de comentarios
                console.log('Comentarios recibidos:', data);
                renderComentarios(data);
            })
            .catch(error => {
                console.error('Hubo un problema con la petición (GET):', error);
                alert('Error al consultar: ' + error.message);
            });
    }

    /**
     * CREAR (Create - POST)
     * Crea un nuevo comentario.
     */
    function crearComentarioConThen(datos) {
        console.log('Creando comentario con .then()...');

        fetch(API_URL, {
            method: 'POST',
            headers: headersModificacion,
            body: JSON.stringify(datos)
        })
        .then(response => {
            if (response.status === 201) { // 201 = Created
                return response.json();
            } else {
                return response.json().then(err => { throw new Error(JSON.stringify(err)) });
            }
        })
        .then(data => {
            console.log('Comentario creado:', data);
            alert(`¡Comentario ID ${data.idcomentariosmaquinas} creado!`);
            resetForm();
            consultarComentariosConThen(); // Actualizamos la lista
        })
        .catch(error => {
            console.error('Hubo un problema con la petición (POST):', error);
            alert('Error al crear: ' + error.message);
        });
    }


    /* ==============================================
       PARTE 2: fetch con Async / Await
       ============================================== */

    /**
     * MODIFICAR (Update - PUT)
     * Modifica un comentario existente.
     */
    const modificarComentarioConAsync = async (id, datos) => {
        console.log(`Modificando comentario ${id} con async/await...`);
        
        try {
            const response = await fetch(`${API_URL}${id}/`, {
                method: 'PUT', // PUT requiere todos los campos
                headers: headersModificacion,
                body: JSON.stringify(datos)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(JSON.stringify(err));
            }

            const data = await response.json();
            console.log('Comentario modificado:', data);
            alert(`¡Comentario ID ${data.idcomentariosmaquinas} modificado!`);
            resetForm();
            consultarComentariosConThen(); // Actualizamos la lista

        } catch (error) {
            console.error('Hubo un problema con la petición (PUT):', error);
            alert('Error al modificar: ' + error.message);
        }
    };

    /**
     * MODIFICAR PARCIAL (Update - PATCH)
     * Modifica solo el estado 'solucionado'.
     */
    const toggleSolucionadoConAsync = async (id, estadoActual) => {
        const nuevoEstado = estadoActual ? 0 : 1; // Invierte el estado
        console.log(`Marcando comentario ${id} como ${nuevoEstado} (PATCH)...`);
        
        try {
            const response = await fetch(`${API_URL}${id}/`, {
                method: 'PATCH', // PATCH solo envía el campo que cambia
                headers: headersModificacion,
                body: JSON.stringify({ solucionado: nuevoEstado })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(JSON.stringify(err));
            }

            const data = await response.json();
            console.log('Estado actualizado:', data);
            consultarComentariosConThen(); // Actualizamos la lista

        } catch (error) {
            console.error('Hubo un problema con la petición (PATCH):', error);
            alert('Error al actualizar estado: ' + error.message);
        }
    };

    /**
     * ELIMINAR (Delete - DELETE)
     * Elimina un comentario por su ID.
     */
    const eliminarComentarioConAsync = async (id) => {
        if (!confirm(`¿Seguro que quieres eliminar el comentario ${id}?`)) {
            return;
        }
        
        console.log(`Eliminando comentario ${id} con async/await...`);

        try {
            const response = await fetch(`${API_URL}${id}/`, {
                method: 'DELETE',
                headers: headersModificacion
            });

            if (response.status === 204) { // 204 = No Content (Éxito)
                console.log('Comentario eliminado');
                alert(`Comentario ID ${id} eliminado exitosamente.`);
                consultarComentariosConThen(); // Actualizamos la lista
            } else if (!response.ok) {
                const err = await response.json();
                throw new Error(JSON.stringify(err));
            }

        } catch (error) {
            console.error('Hubo un problema con la petición (DELETE):', error);
            alert('Error al eliminar: ' + error.message);
        }
    };

    /* ===========================================================
       PARTE 3: Petición AJAX que depende de otra petición
       =========================================================== */
       
    /**
     * Petición Dependiente (con Async/Await)
     * Paso 1: Crea un nuevo comentario.
     * Paso 2: Usa el ID de ese comentario para marcarlo como 'solucionado'.
     */
    const crearYMarcarSolucionado = async () => {
        console.log('Iniciando petición dependiente...');
        
        const datosComentario = {
            idmaquina: 1, // ID de máquina de ejemplo
            idempleado: 1, // ID de empleado de ejemplo
            comentario: 'PETICIÓN DEPENDIENTE: Reporte automático',
            fecharegistro: new Date().toISOString(), // DRF maneja bien ISO strings
            solucionado: 0 // Inicia como no solucionado
        };

        try {
            // --- Petición 1: CREAR (POST) ---
            console.log('Paso 1: Creando comentario...');
            const responseCrear = await fetch(API_URL, {
                method: 'POST',
                headers: headersModificacion,
                body: JSON.stringify(datosComentario)
            });

            if (!responseCrear.ok) {
                const err = await responseCrear.json();
                throw new Error('Error al crear: ' + JSON.stringify(err));
            }

            const comentarioCreado = await responseCrear.json();
            console.log('Paso 1 Exitoso (Creado):', comentarioCreado);
            alert(`Creado comentario temporal con ID: ${comentarioCreado.idcomentariosmaquinas}`);
            
            // --- Petición 2: MODIFICAR (PATCH) ---
            // Esta petición DEPENDE de la anterior
            console.log(`Paso 2: Marcando ${comentarioCreado.idcomentariosmaquinas} como solucionado...`);
            
            const responseModificar = await fetch(`${API_URL}${comentarioCreado.idcomentariosmaquinas}/`, {
                method: 'PATCH',
                headers: headersModificacion,
                body: JSON.stringify({ solucionado: 1 }) // Lo marcamos
            });

            if (!responseModificar.ok) {
                const err = await responseModificar.json();
                throw new Error('Error al modificar: ' + JSON.stringify(err));
            }

            const comentarioModificado = await responseModificar.json();
            console.log('Paso 2 Exitoso (Modificado):', comentarioModificado);
            alert(`Comentario ID ${comentarioModificado.idcomentariosmaquinas} marcado como solucionado.`);
            
            consultarComentariosConThen(); // Actualizamos la lista

        } catch (error) {
            console.error('Error en la petición dependiente:', error);
            alert('Error: ' + error.message);
        }
    };


    /* ==============================================
       ASIGNACIÓN DE EVENTOS (Listeners)
       ============================================== */

    // 1. Botón global de Consultar
    btnConsultar.addEventListener('click', consultarComentariosConThen);

    // 2. Botón global de Petición Dependiente
    btnDependiente.addEventListener('click', crearYMarcarSolucionado);

    // 3. Botón de Limpiar Formulario
    btnResetForm.addEventListener('click', resetForm);

    // 4. Envío del Formulario (para CREAR o MODIFICAR)
    formComentario.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const id = inputId.value;
        const datos = {
            idmaquina: inputMaquina.value,
            idempleado: inputEmpleado.value,
            comentario: inputTexto.value,
            // Tu serializer necesita fecharegistro y solucionado
            fecharegistro: new Date().toISOString(), // El backend debería manejar esto, pero lo mandamos por si acaso
            solucionado: 0 // Por defecto al crear
        };

        if (id) {
            // Si hay un ID, estamos MODIFICANDO (PUT)
            // Ajustamos 'solucionado' por si venía de una edición
            const li = listaComentarios.querySelector(`li[data-id="${id}"]`);
            const estadoActual = li.classList.contains('solucionado');
            datos.solucionado = estadoActual ? 1 : 0;
            
            modificarComentarioConAsync(id, datos);
        } else {
            // Si no hay ID, estamos CREANDO (POST)
            crearComentarioConThen(datos);
        }
    });

    // 5. Clicks en los botones de la lista (Usando Delegación de Eventos)
    listaComentarios.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (!id) return; // Click fuera de un botón

        // Clic en botón ELIMINAR (async/await)
        if (e.target.classList.contains('btn-eliminar')) {
            eliminarComentarioConAsync(id);
        }

        // Clic en botón SOLUCIONAR (async/await con PATCH)
        if (e.target.classList.contains('btn-solucionar')) {
            const li = e.target.closest('li');
            const estadoActual = li.classList.contains('solucionado');
            toggleSolucionadoConAsync(id, estadoActual);
        }

        // Clic en botón EDITAR (Carga datos al formulario)
        if (e.target.classList.contains('btn-editar')) {
            // Usamos fetch para obtener los datos más frescos de ese ID
            try {
                const response = await fetch(`${API_URL}${id}/`);
                if (!response.ok) throw new Error('No se pudo cargar el comentario');
                const data = await response.json();
                
                // Llenar el formulario
                inputId.value = data.idcomentariosmaquinas;
                inputMaquina.value = data.idmaquina;
                inputEmpleado.value = data.idempleado;
                inputTexto.value = data.comentario;
                
                // Cambiar botón de submit
                btnSubmitComentario.textContent = `Modificar Comentario ${data.idcomentariosmaquinas} (PUT)`;
                btnSubmitComentario.style.backgroundColor = '#007bff';
                
                // Scroll hacia el formulario
                formComentario.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert(error.message);
            }
        }
    });

    // Carga inicial al abrir la página
    consultarComentariosConThen();
});
</script>

{% endblock %}